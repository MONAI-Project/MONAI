# Copyright 2020 MONAI Consortium
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#     http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import unittest

import numpy as np
import torch
from parameterized import parameterized

from monai.networks.blocks import CRF
from tests.utils import skip_if_no_cpp_extention, skip_if_no_cuda

TEST_CASES = [
    [
        # Case Description
        "2 batche(s), 1 dimension(s), 2 classe(s), 1 channel(s)",
        # Parameters
        [
            3.0, # bilateral_weight
            1.0, # gaussian_weight
            5.0, # bilateral_spatial_sigma
            0.5, # bilateral_color_sigma
            5.0, # gaussian_spatial_sigma
            1, # compatability_kernel_range
            5, # iterations
        ],
        # Input
        [
            # Batch 0
            [
                # Class 0
                [0.8, 0.9, 0.6, 0.2, 0.3],

                # Class 1
                [0.1, 0.3, 0.5, 0.8, 0.7]
            ],
            # Batch 1
            [
                # Class 0
                [0.8, 0.9, 0.6, 0.2, 0.3],

                # Class 1
                [0.1, 0.3, 0.5, 0.8, 0.7]
            ],
        ],
        # Features
        [
            # Batch 0
            [
                # Channel 0
                [1, 1, 1, 0.5, 0],
            ],
            # Batch 1
            [
                # Channel 0
                [1, 1, 0.5, 0, 0],
            ],
        ],
        # Expected
        [
            # Batch 0
            [
                # Class 0
                [0.89333 , 0.881837, 0.787194, 0.55363 , 0.507627],

                # Class 1
                [0.10667 , 0.118163, 0.212806, 0.44637 , 0.492373]
            ],
            # Batch 1
            [
                # Class 0
                [0.846356, 0.777572, 0.536503, 0.241165, 0.232537],
                
                # Class 1
                [0.153644, 0.222428, 0.463497, 0.758835, 0.767463]
            ],
        ],
    ],
    [
        # Case Description
        "1 batche(s), 2 dimension(s), 3 classe(s), 2 channel(s)",
        # Parameters
        [
            3.0, # bilateral_weight
            1.0, # gaussian_weight
            5.0, # bilateral_spatial_sigma
            0.5, # bilateral_color_sigma
            5.0, # gaussian_spatial_sigma
            1, # compatability_kernel_range
            5, # iterations
        ],
        # Input
        [
            # Batch 0
            [
                # Class 0
                [
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 1.0, 1.0],
                    [0.0, 0.0, 0.0, 1.0, 1.0],
                ],

                # Class 1
                [
                    [1.0, 1.0, 0.0, 0.0, 0.0],
                    [1.0, 1.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                ],
                
                # Class 2
                [
                    [0.0, 0.0, 0.0, 1.0, 1.0],
                    [0.0, 0.0, 1.0, 1.0, 1.0],
                    [0.0, 1.0, 1.0, 1.0, 0.0],
                    [1.0, 1.0, 1.0, 0.0, 0.0],
                    [1.0, 1.0, 0.0, 0.0, 0.0],
                ],
            ],
        ],
        # Features
        [
            # Batch 0
            [
                # Channel 0
                [
                    [1.0, 1.0, 0.0, 0.0, 0.0],
                    [1.0, 1.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                ],

                # Channel 1
                [
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 0.0, 0.0],
                    [0.0, 0.0, 0.0, 1.0, 1.0],
                    [0.0, 0.0, 0.0, 1.0, 1.0],
                ],
            ],
        ],
        # Expected
        [
            # Batch 0
            [
                # Class 0
                [
                    [0.000257, 0.000283, 0.000311, 0.000126, 0.000126],
                    [0.000376, 0.000458, 0.000216, 0.000257, 0.000264],
                    [0.000693, 0.000347, 0.001017, 0.002675, 0.015330],
                    [0.000604, 0.000824, 0.004701, 0.148476, 0.425911],
                    [0.000987, 0.001379, 0.038858, 0.516412, 0.896450]
                ],

                # Class 1
                [
                    [0.000702, 0.000664, 0.000230, 0.000081, 0.000080],
                    [0.000771, 0.000793, 0.000113, 0.000115, 0.000116],
                    [0.000348, 0.000144, 0.000237, 0.000370, 0.001437],
                    [0.000177, 0.000207, 0.000491, 0.002529, 0.003492],
                    [0.000224, 0.000265, 0.002267, 0.003538, 0.002137]
                ],
                
                # Class 2
                [
                    [0.999041, 0.999054, 0.999459, 0.999793, 0.999793],
                    [0.998852, 0.998749, 0.999672, 0.999628, 0.999621],
                    [0.998959, 0.999509, 0.998746, 0.996955, 0.983234],
                    [0.999219, 0.998969, 0.994808, 0.848995, 0.570597],
                    [0.998789, 0.998356, 0.958874, 0.480050, 0.101413]
                ],
            ],
        ],
    ],
    [
        # Case Description
        "1 batche(s), 3 dimension(s), 2 classe(s), 1 channel(s)",
        # Parameters
        [
            8.0, # bilateral_weight
            1.0, # gaussian_weight
            5.0, # bilateral_spatial_sigma
            0.1, # bilateral_color_sigma
            5.0, # gaussian_spatial_sigma
            1, # compatability_kernel_range
            2, # iterations
        ],
        # Input
        [
            # Batch 0
            [
                # Class 0
                [
                    # Slice 0
                    [
                        [1.0, 1.0, 0.0, 0.0, 0.0],
                        [1.0, 1.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 1
                    [
                        [1.0, 1.0, 0.0, 0.0, 0.0],
                        [1.0, 1.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 2
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 3
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 4
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                ],

                # Class 1
                [
                    # Slice 0
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 1
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 2
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 3
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 1.0, 1.0],
                        [0.0, 0.0, 0.0, 1.0, 1.0],
                    ],
                    # Slice 4
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 1.0, 1.0],
                        [0.0, 0.0, 0.0, 1.0, 1.0],
                    ],
                ],
            ],
        ],
        # Features
        [
            # Batch 0
            [
                # Channel 0
                [
                    # Slice 0
                    [
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 1
                    [
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                    ],
                    # Slice 2
                    [
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.5, 0.0, 0.0],
                        [0.5, 0.5, 0.8, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                    ],
                    # Slice 3
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                    ],
                    # Slice 4
                    [
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 0.0, 0.0, 0.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                        [0.0, 0.0, 1.0, 1.0, 1.0],
                    ],
                ],
            ],
        ],
        # Expected
        [
            # Batch 0
            [
                # Class 0
                [
                    # Slice 0
                    [
                        [1.000000, 1.000000, 0.999999, 0.999400, 0.672704],
                        [1.000000, 1.000000, 0.999999, 0.999311, 0.634444],
                        [0.999999, 0.999999, 0.999923, 0.992283, 0.570609],
                        [0.999347, 0.999270, 0.992103, 0.915680, 0.497763],
                        [0.641561, 0.611654, 0.561265, 0.496694, 0.447266]
                    ],
                    # Slice 1
                    [
                        [1.000000, 1.000000, 0.999999, 0.999297, 0.628315],
                        [1.000000, 1.000000, 0.999996, 0.991844, 0.143119],
                        [0.999999, 0.999995, 0.998187, 0.561012, 0.015132],
                        [0.999211, 0.991375, 0.560541, 0.013006, 0.001419],
                        [0.584354, 0.132132, 0.015294, 0.001480, 0.001224]
                    ],
                    # Slice 2
                    [
                        [0.999999, 0.999999, 0.999920, 0.991880, 0.556050],
                        [0.999999, 0.999995, 0.998105, 0.545511, 0.014186],
                        [0.999915, 0.998068, 0.566432, 0.003078, 0.000158],
                        [0.990786, 0.537158, 0.003170, 0.000008, 0.000002],
                        [0.510227, 0.013575, 0.000172, 0.000002, 0.000002]
                    ],
                    # Slice 3
                    [
                        [0.999278, 0.999206, 0.991367, 0.909220, 0.479173],
                        [0.999193, 0.990973, 0.534392, 0.011364, 0.001236],
                        [0.990854, 0.535103, 0.002982, 0.000007, 0.000002],
                        [0.902482, 0.011722, 0.000008, 0.000000, 0.000000],
                        [0.456381, 0.001320, 0.000002, 0.000000, 0.000000]
                    ],
                    # Slice 4
                    [
                        [0.606149, 0.580932, 0.528721, 0.472177, 0.429050],
                        [0.576264, 0.124628, 0.013063, 0.001210, 0.001002],
                        [0.517166, 0.013384, 0.000150, 0.000002, 0.000001],
                        [0.467132, 0.001316, 0.000002, 0.000000, 0.000000],
                        [0.432737, 0.001164, 0.000002, 0.000000, 0.000000]
                    ],
                ],

                # Class 1
                [
                    # Slice 0
                    [
                        [0.000000, 0.000000, 0.000001, 0.000600, 0.327296],
                        [0.000000, 0.000000, 0.000001, 0.000689, 0.365556],
                        [0.000001, 0.000001, 0.000077, 0.007717, 0.429391],
                        [0.000653, 0.000729, 0.007897, 0.084320, 0.502237],
                        [0.358439, 0.388346, 0.438735, 0.503306, 0.552734]
                    ],
                    # Slice 1
                    [
                        [0.000000, 0.000000, 0.000001, 0.000703, 0.371685],
                        [0.000000, 0.000000, 0.000004, 0.008156, 0.856880],
                        [0.000001, 0.000005, 0.001814, 0.438988, 0.984868],
                        [0.000789, 0.008625, 0.439459, 0.986994, 0.998581],
                        [0.415646, 0.867868, 0.984706, 0.998520, 0.998776]
                    ],
                    # Slice 2
                    [
                        [0.000001, 0.000001, 0.000080, 0.008120, 0.443950],
                        [0.000001, 0.000005, 0.001895, 0.454489, 0.985814],
                        [0.000085, 0.001932, 0.433568, 0.996922, 0.999842],
                        [0.009214, 0.462842, 0.996830, 0.999992, 0.999998],
                        [0.489773, 0.986425, 0.999828, 0.999998, 0.999998]
                    ],
                    # Slice 3
                    [
                        [0.000722, 0.000794, 0.008633, 0.090780, 0.520827],
                        [0.000807, 0.009027, 0.465608, 0.988636, 0.998764],
                        [0.009146, 0.464897, 0.997018, 0.999993, 0.999998],
                        [0.097518, 0.988278, 0.999992, 1.000000, 1.000000],
                        [0.543619, 0.998680, 0.999998, 1.000000, 1.000000]
                    ],
                    # Slice 4
                    [
                        [0.393851, 0.419068, 0.471279, 0.527823, 0.570950],
                        [0.423736, 0.875372, 0.986937, 0.998790, 0.998998],
                        [0.482834, 0.986616, 0.999850, 0.999998, 0.999999],
                        [0.532868, 0.998684, 0.999998, 1.000000, 1.000000],
                        [0.567263, 0.998836, 0.999998, 1.000000, 1.000000]
                    ],
                ],
            ],
        ],
    ],
]


@skip_if_no_cpp_extention
class CRFTestCaseCuda(unittest.TestCase):
    
    @parameterized.expand(TEST_CASES)
    def test(self, test_case_description, params, input, features, expected):

        # Create input tensors
        input_tensor = torch.from_numpy(np.array(input)).to(dtype=torch.float, device=torch.device("cuda"))
        feature_tensor = torch.from_numpy(np.array(features)).to(dtype=torch.float, device=torch.device("cuda"))

        # apply filter
        crf = CRF(*params)
        output = crf(input_tensor, feature_tensor).cpu().numpy()

        # Ensure result are as expected
        np.testing.assert_allclose(output, expected, atol=1e-4)


if __name__ == "__main__":
    unittest.main()
